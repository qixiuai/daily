
import pdb
import numpy as np
import contextlib2

from absl import app
from absl import flags
from absl import logging

from isruc import RawIsruc
from pai.dataset_tools.stage_tf_records_utils import tf_example_from_dict
from pai.dataset_tools.tf_record_creation_util import write_sharded_tf_records
import pdb

def make_isruc_tf_examples(dataset, channels):
    for example, labels1, labels2, filepath in dataset:
        dt = {}
        #print(example.shape, labels1.shape, filepath)
        for id, channel_name in enumerate(channels):
            if channel_name == "C3_A2":
                channel_name =  "C3_M2"
            elif channel_name == "C4_A1":
                channel_name = "C4_M1"
            elif channel_name == "O1_A2":
                channel_name = "O1_M2"
            elif channel_name == "LOC_A2":
                channel_name = "E1_M2"
            elif channel_name == "ROC_A1":
                channel_name = "E2_M2"
            elif channel_name == "X1":
                channel_name = "EMG"
            dt[channel_name] = example[:,:,id]
        dt["epochs"] = len(labels1)
        dt["labels"] = labels1
        dt["labels2"] = labels2
        dt["filepath"] = filepath
        example = tf_example_from_dict(dt)
        yield example


def main(unused_args):
    del unused_args
    tf_record_dir = "/home/guo/physio/dl/tfrecords/isruc.tfrecords/"
    channels = ["C3_A2", "C4_A1", "O1_A2", "LOC_A2", "ROC_A1", "X1"]

    train_isruc = RawIsruc(mode="train", channels=channels)
    tf_examples = make_isruc_tf_examples(train_isruc(), channels)
    write_sharded_tf_records(tf_record_dir + "isruc.train.tfrecords", tf_examples, num_shards=10)

    return

    valid_isruc = RawIsruc(mode="validation", channels=channels)
    tf_examples = make_isruc_tf_examples(valid_isruc(), channels)
    write_sharded_tf_records(tf_record_dir + "isruc.valid.tfrecords", tf_examples, num_shards=5)

    test_isruc = RawIsruc(mode="test", channels=channels)
    tf_examples = make_isruc_tf_examples(test_isruc(), channels)
    write_sharded_tf_records(tf_record_dir + "isruc.test.tfrecords", tf_examples, num_shards=5)


if __name__ == "__main__":
    app.run(main)



