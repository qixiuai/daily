""" deepsleepnet: https://github.com/akaraspt/deepsleepnet """

from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

from absl import app
from absl import flags
from absl import logging

import tensorflow.keras as keras
import tensorflow as tf

from tensorflow.keras.models import Model
from tensorflow.keras.layers import Layer
from tensorflow.keras.layers import Input, Dense, Conv1D, MaxPooling1D
from tensorflow.keras.layers import Flatten, Dropout, BatchNormalization

import pdb

class Conv1DBN(Layer):

    def __init__(self, filters=None, kernel_size=None, strides=1, activation="relu"):
        super(Conv1DBN, self).__init__()
        self.conv = Conv1D(filters=filters,
                           kernel_size=kernel_size,
                           strides=strides,
                           padding="same",
                           activation=activation)
        self.batch_norm = BatchNormalization()
        
    def call(self, inputs):
        x = self.conv(inputs)
        x = self.batch_norm(x)
        return x


class SlowWaveBlock(Layer):

    def __init__(self):
        super(SlowWaveBlock, self).__init__()
        self.conv_input = Conv1DBN(filters=64, kernel_size=400, strides=50)
        self.conv_middle_1 = Conv1DBN(filters=128, kernel_size=6, strides=1)
        self.conv_middle_2 = Conv1DBN(filters=128, kernel_size=6, strides=1)
        self.conv_middle_3 = Conv1DBN(filters=128, kernel_size=6, strides=1)
        self.max_pool_4 = MaxPooling1D(pool_size=4, strides=4, padding="same")
        self.max_pool_2 = MaxPooling1D(pool_size=2, strides=2, padding="same")
        self.dropout = Dropout(0.5)
        self.flatten = Flatten()
        self.bn = BatchNormalization()
        
    def call1(self, inputs):
        inputs = self.bn(inputs)
        x = self.conv_input(inputs)
        x = self.flatten(x)
        return x
    
    def call(self, inputs):
        x = self.conv_input(inputs)
        x = self.max_pool_4(x)
        x = self.dropout(x)
        x = self.conv_middle_1(x)
        x = self.conv_middle_2(x)
        x = self.conv_middle_3(x)
        x = self.max_pool_2(x)
        x = self.flatten(x)
        return x


class QuickWaveBlock(Layer):

    def __init__(self):
        super(QuickWaveBlock, self).__init__()
        self.conv_input = Conv1DBN(filters=64, kernel_size=50, strides=6)
        self.conv_middle_1 = Conv1DBN(filters=128, kernel_size=8)
        self.conv_middle_2 = Conv1DBN(filters=128, kernel_size=8)
        self.conv_middle_3 = Conv1DBN(filters=128, kernel_size=8)
        self.max_pool_8 = MaxPooling1D(pool_size=8, strides=8)
        self.max_pool_4 = MaxPooling1D(pool_size=4, strides=4)
        self.dropout = Dropout(0.5)
        self.flatten = Flatten()
        self.bn = BatchNormalization()
        
    def call1(self, inputs):
        inputs = self.bn(inputs)
        x = self.conv_input(inputs)
        x = self.max_pool_8(x)
        x = self.dropout(x)
        x = self.conv_middle_1(x)
        #x = self.conv_middle_2(x)
        #x = self.conv_middle_3(x)
        x = self.max_pool_4(x)
        x = self.flatten(x)
        return x
        
    def call(self, inputs):
        x = self.conv_input(inputs)
        x = self.max_pool_8(x)
        x = self.dropout(x)
        x = self.conv_middle_1(x)
        x = self.conv_middle_2(x)
        x = self.conv_middle_3(x)
        x = self.max_pool_4(x)
        x = self.flatten(x)
        return x


class DeepFeatureNet(Model):

    def __init__(self):
        super(DeepFeatureNet, self).__init__()
        self.slow_wave_block = SlowWaveBlock()
        self.quick_wave_block = QuickWaveBlock()
        self.dropout = Dropout(0.5)
        self.dense_softmax = Dense(5, activation="softmax")

    def call(self, inputs):
        slow = self.slow_wave_block(inputs)
        quick = self.quick_wave_block(inputs)
        x = tf.concat([slow, quick], axis=1)
        x = self.dropout(x)
        x = self.dense_softmax(x)
        return x

