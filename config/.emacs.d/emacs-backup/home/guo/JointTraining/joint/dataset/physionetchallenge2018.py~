
""" produce dataset from physiochallengle2018 """

from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import os
import numpy as np
import pandas as pd
import tensorflow as tf
import physionetchallenge2018_lib as phyc_lib

from glob import glob

from sklearn.model_selection import train_test_split

import pdb

class PhysioChallengeDataset(object):

    def __init__(self, is_train=True, is_debug=True, seq_len=6000):
        self.data_dir = "/home/guo/Flake/arousal/data/"
        self.is_train = is_train
        self.is_debug = is_debug
        self.seq_len = seq_len # sequence length set to be 1*30s 1*30*200=6000

    def __call__(self):
        train_files_df, test_files_df = phyc_lib.get_files()
        files_df = train_files_df
        if self.is_train:
            files_df = files_df
        else:
            files_df = files_df

        num_train_files = 5
        if self.is_train:
            files_df = files_df.iloc[:num_train_files,:]
        else:
            files_df = files_df.iloc[num_train_files:num_train_files+5,:]

        for index, row in files_df.iterrows():
            basename = os.path.basename(row['signal'])[:-4]
            header_file, arousal_file, signal_file, is_traing = row
            signal_names, fs, n_samples = phyc_lib.import_signal_names(header_file)
            signal_names = list(np.append(signal_names, 'arousals'))
            df = phyc_lib.get_subject_data(arousal_file, signal_file, signal_names)
            column_names = ['F3-M2', 'F4-M1', 'C3-M2', 'C4-M1', 'O1-M2', 'O2-M1', 'E1-M2',
                            'Chin1-Chin2',]
            data = df[column_names]
            labels = df['arousals']
            data, labels = np.array(data), np.array(labels)
            # set -1 not scores to 0 as non-arousal region
            labels[labels == -1] = 0
            total_record_length = data.shape[0] - self.seq_len
            for i in range(0, total_record_length, self.seq_len):
                x = data[i:i+self.seq_len,:]
                y = labels[i:i+self.seq_len]
                if np.sum(y) == 0:
                    continue
                yield (x, y)

if __name__ == "__main__":
    phyc_dataset = PhysioChallengeDataset(is_train=True)
    for example in phyc_dataset():
        pdb.set_trace()
