#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Wed Nov 28 15:56:36 2018

@author: l1480
"""

# 引入自己写的addrsample包，这样后面就可以用该包里的函数了
import addrsample
import readcsv
import addrpre_preprocess

CUT_LEN = 6
CUT_LEN_3 = 4


# detail_addr = [['DL_531311142050010005', '浙江省衢州市江山市城南社区虎山街道市区绿苑山庄70号1单元301室'],
# ['DL_521311151631340002', '浙江省衢州市江山市新塘边镇警务区新塘边镇下社坂18号周杰灯具店'],
# ['DL_521311182025450004', '浙江省衢州市江山市清湖镇警务区清湖镇清泉一区264号1单元201室'],
# ...]]

def addr_cut(single_addr, lv):
    '''
    对单个地址进行一个级别item切分
    eg: 
        single_addr: ['num', '浙江省衢州市江山市新塘边镇警务区新塘边镇下社坂18号周杰灯具店']
        
        
    Args:
        single_addr: 单个地址
        lv: 第num级别 eg:lvnum
    
    Return:
        None
        
    '''
    #单独处理'国家'级别
    if lv[0] == 0:
        for lv_item in lv[1]:
            l = len(lv_item)
            if single_addr[:l] == lv_item:
                return(l,l)
    # 除国家外的级别
    else:
        for lv_item in lv[1]:
            l = len(lv_item)
            if lv[0] < 4:
                length = CUT_LEN_3 + l
            else:
                length = CUT_LEN + l
            index = single_addr[:length].find(lv_item)
            # print(index)
            if index != -1:
                #print(lv_item)
                b = index + l
                return(b,l)
        return(None)
        
# 对单个地址进行各个级别全部切分
# addr_units = ['浙江省','杭州市','西湖区','转塘街道','方家苑小区','12号楼','2单元','201室']
# unrecode
def addr_cut_all_lvs(single_addr, lvs):
    addr_units = []
    for lv in lvs:
        found = addr_cut(single_addr,lv)
        if found != None:
            temp = [single_addr[0:found],lv[0]]
            addr_units.append(temp)
            single_addr = single_addr[found:]
            '''
            single_addr = [single_addr[0:found],str(num)]
            str(num)这个没用，list添加元素就是以字符形式添加，无需转换成str形式，这样增加了无用的时间复杂度
            addr_units.append(single_addr)
            single_addr = single_addr[found:]
           '''
# 对单个地址各个级别切分后如果有剩下的小尾巴也要加到addr_units里
    if len(single_addr) != 0:
        temp = [single_addr, 99]
        addr_units.append(temp)
    return(addr_units)
# 后将single_addr列表中加了序号，及single_addr[0]='DL_521311151631340002'

# single_addr = ['DL_521311151631340002', '浙江省衢州市江山市新塘边镇警务区新塘边镇下社坂18号周杰灯具店']


def addr_cut_all_lvs_with_no(single_addr, lvs):
    '''
    将一个地址进行所以级别的切分
    eg:
        addr_units:['DL_521311151631340002',['浙江省', 1],['衢州市', 2],['江山市新塘边镇', 4],['警务区', 6.3],['新塘边镇下社坂18号周杰灯具店', 99]] 
        lvs = [lv1,lv2,lv2_1,lv3,...]
        
    
    Args:
        single_addr: 单个地址 
        lvs: 由所有级别组成的列表
    
    Returns:
        addr_units:对单个地址以所有级别切分后所得的列表
    '''
    addr_units = []
    addr_units.append(single_addr[0])
#    print(single_addr)
    single_addr = single_addr[1]
    for lv in lvs:
        res = addr_cut(single_addr,lv)
        if res != None:
            found = res[0]
            l = res[1]
            # lv[0]:地址被lv[0]级别所切割
            temp = [single_addr[0:found],lv[0],l]
            addr_units.append(temp)
            single_addr = single_addr[found:]
    if len(single_addr) != 0:
        temp = [single_addr, 99, 0]
        addr_units.append(temp)
    return(addr_units)

# unrecord:
def cut_all_addr(detail_addr, lvs):
    addrs = []
    for single_addr in detail_addr:
        addr_units = addr_cut_all_lvs(single_addr, lvs)
        addrs.append(addr_units)
    return(addrs)

def cut_all_addr_with_no(detail_addr, lvs):
    '''
    对所有地址以所有级别进行切分
    detail_addr: [['DL_521311151631340002', '浙江省衢州市江山市新塘边镇警务区新塘边镇下社坂18号周杰灯具店'],...]
    addrs: [['DL_521311151631340002',['浙江省', 1],['衢州市', 2],['江山市新塘边镇', 4],['警务区', 6.3],['新塘边镇下社坂18号周杰灯具店', 99],[...],...]],
    Args:
        detail_addr: readcsv读入的所有地址组成的列表
        lvs: 所有级别组成的列表
        
    Returns:
        addrs: detail_addr按照所有级别切分后所得结果

    '''
    addrs = []
    for single_addr in detail_addr:
#        print('single_addr = %s' %single_addr)
        addr_units = addr_cut_all_lvs_with_no(single_addr, lvs)
        addrs.append(addr_units)
    return(addrs)
    
if __name__ == '__main__':
    #detail_addr = ['衢州市江山市坛石镇警务区坛石镇新叶村岭下17-2号1单元301室',]
    path = r'/Users/l1480/Desktop/pcsmk_dz2_no_quotes.csv'
    detail_addr = readcsv.read_csv(path,encoding='UTF-8', idMark = 'PCS')
#    detail_addr = [['num1','浙江省衢州市柯城区信安街道府东街1幢656-1号7单元502室'],]
    detail_addr = addrpre_preprocess.replace(detail_addr)
    lvs = addrsample.lvs
    
    addrs = cut_all_addr_with_no(detail_addr, lvs)
    print(addrs)
    
    


