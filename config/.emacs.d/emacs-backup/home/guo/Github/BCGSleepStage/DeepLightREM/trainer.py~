""" train the CNN model """

from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import tensorflow as tf

import gin

from absl import app
from absl import logging

from dataset import IsrucDataset
from model import DukeCNN
from model import get_model_DukeCNN
from model import get_standard_DukeCNN
from deepsleepnet import DeepFeatureNet

from tensorflow.keras.callbacks import TensorBoard

class Trainer(object):
    """ Trainer """
    
    def __init__(self):
       pass

    def train(self):
       isruc_train = IsrucDataset(train=True)
       dataset_train = tf.data.Dataset.from_generator(isruc_train, (tf.float32, tf.int64))
       isruc_test = IsrucDataset(train=False)
       dataset_test = tf.data.Dataset.from_generator(isruc_test, (tf.float32, tf.int64))
       batch_size = 1024
       dataset_train = dataset_train.shuffle(buffer_size=batch_size*10).batch(batch_size)
       dataset_test = dataset_test.shuffle(buffer_size=batch_size*100).batch(batch_size*10)
       #model = get_model_DukeCNN()
       model = get_standard_DukeCNN()
       #model = DeepFeatureNet
       model.compile(loss="binary_crossentropy",
                     optimizer="adam",
                     metrics=['binary_accuracy'])
       
       callbacks = [TensorBoard("/home/guo/data/sleepstage/logs/7_paper")]
       model.fit(dataset_train, epochs=1000, validation_data=dataset_test, callbacks=callbacks)
       tf.keras.experimental.export_saved_model(
           model, "/home/guo/BCGSleepStage/DukeCNN/saved_models", serving_only=True)


def main(argv):
    del argv
    trainer = Trainer()
    trainer.train()


if __name__ == "__main__":
    app.run(main)
