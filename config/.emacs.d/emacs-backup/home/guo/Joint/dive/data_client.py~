
import zmq
import pickle
import numpy as np
import tensorflow as tf

class DataClient(object):

    def __init__(self, batch_size=1, step=1, mode="train", channels=["C3_A2", "LOC_A2", "X1"]):
        context = zmq.Context()
        socket = context.socket(zmq.REQ)
        socket.connect("ipc://DataServer")
        self.socket = socket
        parameter = {"mode": mode, "step": step, "channels": channels}
        self.parameter = pickle.dumps(parameter)
        
    def __call__(self):
        while True:
            self.socket.send(self.parameter)
            message = self.socket.recv()
            examples, targets = pickle.loads(message)
            if len(examples) == 0:
                break
            yield (examples, targets)


if __name__ == "__main__":
    client = DataClient()
    for x,y in client():
        print(x.shape)
    for x,y in client():
        print(x.shape)
