#include <iostream>
#include <fstream>
#include <vector>
#include <string>

#include "findpeaks.h"
#include "filter.h"
#include "bcg.h"

BCGResult BCGFramework::run(int value) {
  double med_low  = this->medfilter_low.realtime_filter(value);
  double med_high = this->medfilter_high.realtime_filter(value);
  double val_low  = this->lowpass.realtime_filter(med_low);
  double val_high = this->highpass.realtime_filter(med_high);
  int resp_rate  = this->resp_detector.run(val_low);
  int heart_rate = this->heart_detector.run(val_high);
  if (resp_rate >= 18) {
    std::cout << value << ',' << val_low << ',' << resp_rate << '\n';
  }
  BCGResult result;
  result.respiratory_rate = resp_rate;
  result.heart_rate = heart_rate;  
  return result;
}

vector<int> load_signal(std::string file_path) {
  std::fstream in(file_path);
  if (!in.is_open()) {
    std::cout << file_path << " is not found\n";
  }
  std::vector<int> signal;
  std::string line;
  while (getline(in, line)) {
    signal.push_back(std::stoi(line));
  }
  return signal;
}


int main() {
  std::vector<int> signal = load_signal("/home/guo/AwareCore/BCGGongzhuang/data/parsed_context.txt");
  std::string data_dir = "/home/guo/AwareCore/BCGGongzhuang/coeffs/";
  auto bcg = BCGFramework();
  for (auto v : signal) {
    auto ret = bcg.run(v);
    //    std::cout << ret.respiratory_rate<< ',';
    //    std::cout << ret.heart_rate << '\n';
  }
  return 0;
}

