import os
import numpy as np
from glob import glob
from scipy.signal import lfilter
from scipy.signal import medfilt
import pdb

def lowpass(signal):
    a = np.loadtxt('coeffs/lowpass_a.csv', delimiter=',')
    b = np.loadtxt('coeffs/lowpass_b.csv', delimiter=',')
    return lfilter(b, a, signal)

def highpass(signal):
    a = np.loadtxt('coeffs/highpass_a.csv', delimiter=',')
    b = np.loadtxt('coeffs/highpass_b.csv', delimiter=',')
    return lfilter(b, a, signal)

class RealTimeFilter(object):
    def __init__(self, filter_type):
        a = np.loadtxt('coeffs/'+filter_type+'_a.csv', delimiter=',')
        b = np.loadtxt('coeffs/'+filter_type+'_b.csv', delimiter=',')
        self.b = b
        self.a = a
        self.zi = lfilter(b, a)
        
    def filter(self, x, zi):
        y, zi = lfilter(self.b, self.a, [x], zi=zi)
        return y, zi

def load_data(file_path):
    data = np.loadtxt(file_path, delimiter=';')
    return data

def save_data(out_path, signal):
    with open(out_path, 'w') as out:
        for val in signal:
            out.write(str(val)+'\n')

def main(data_dir):
    for filename in os.listdir(data_dir):
        filename = "Wu气流+热敏(31℃室温-吴绍鑫).txt"
        file_path = os.path.join(data_dir, filename)
        data      = load_data(file_path)
        signal1 = medfilt(data[:,0], kernel_size=101)
        signal_filt1 = lowpass(signal1)
        signal2 = medfilt(data[:,1], kernel_size=101)
        signal_filt2 = lowpass(signal2)
        filt_data = np.similar(data)
        filt_data[:,0] = signal_filt1
        filt_data[:,1] = signal_filt2
        out_path    = data_dir + 'lowpass1_' + filename
        save_data(out_path, signal_filt1)
        out_path    = data_dir + 'lowpass2_' + filename
        save_data(out_path, signal_filt2)

if __name__ == '__main__':
    data_dir = '../data/'
    main(data_dir)

        

