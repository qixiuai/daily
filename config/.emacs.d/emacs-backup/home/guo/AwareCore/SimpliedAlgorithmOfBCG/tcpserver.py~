import os
import socket
import sys
import traceback
import time
from parser import Parser


def startTCPServer(parse_func, out_file_path):
    __out_file = open(out_file_path, "w");
    __socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM);
    __socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1);
    __socket.bind(("192.168.4.3", 7006));
    __socket.listen(5);
    try:
        __connection, __address = __socket.accept();
        __tic = time.time();
        __num_packet_received = 0;
        while (True):
            __buf = __connection.recv(1500);
            __num_packet_received += 1;
            print(__buf);
            __parsed = parse_func(__buf);
            for __num in __parsed:
                __out_file.write(str(__num));
    except:
        exc_type, exc_value, exc_traceback = sys.exc_info();
        info = "".join(traceback.format_exception(exc_type, exc_value, exc_traceback));
        print(info);
        __toc = time.time();
        __dur = __toc - __tic;
        print("time elapsed: {}, get {} packets".format(__dur, __num_packet_received));
        __connection.close();
        __socket.close();
        __out_file.close();
        sys.exit(0);

def main(out_file_path):
    parse_func = Parser().parse;
    startTCPServer(parse_func, out_file_path);

if __name__ == '__main__':
    out_file_path = "data/tcp_parsed_data.txt";
    main(out_file_path);
